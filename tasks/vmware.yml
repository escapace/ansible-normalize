---
# - name: Add VMWare tools repository.
#   template:
#     src: vmware-tools.repo.j2
#     dest: /etc/yum.repos.d/vmware-tools.repo
#     mode: 0644

- name: import vmware tools gpg keys
  rpm_key:
    key: "{{ item }}"
    state: present
  with_items:
    - "http://packages.vmware.com/tools/keys/VMWARE-PACKAGING-GPG-RSA-KEY.pub"

- name: add vmhgfs module
  template:
    src: vmhgfs.modules.j2
    dest: /etc/sysconfig/modules/vmhgfs.modules
    mode: 0755
  when: ansible_distribution_major_version|int <= 6

- name: install open-vm-tools
  package: name=open-vm-tools state=present

- name: create temporary directories for vmware tools
  file:
    path: "/tmp/{{ item }}"
    state: directory
    mode: 0755
  with_items:
    - vmfusion
    - vmfusion-archive

- name: mount vmware tools
  mount:
    name: /tmp/vmfusion
    src: /home/vagrant/linux.iso
    fstype: iso9660
    opts: loop
    state: mounted

- name: decompress vmware tools installer into archive folder
  shell: tar xzf /tmp/vmfusion/VMwareTools-*.tar.gz -C /tmp/vmfusion-archive
  changed_when: true
  tags: ['skip_ansible_lint']

- name: run the vmware tools installer
  command: /tmp/vmfusion-archive/vmware-tools-distrib/vmware-install.pl --default
  changed_when: true

- name: unmount vmware tools
  mount:
    name: /tmp/vmfusion
    src: /home/vagrant/linux.iso
    fstype: iso9660
    state: absent

- name: remove temporary directories for vmware tools
  file:
    path: "/tmp/{{ item }}"
    state: absent
  with_items:
    - vmfusion
    - vmfusion-archive

- name: delete vmware tools
  file:
    path: /home/vagrant/linux.iso
    state: absent
